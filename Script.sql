CREATE TABLE CLIENTE (
  IDCLIENTE INT NOT NULL PRIMARY KEY,
  NOME VARCHAR(200),
  UF VARCHAR(2),
  CELULAR VARCHAR(20)
);

CREATE TABLE FINANCIAMENTO(
  IDFINANCIAMENTO INT NOT NULL PRIMARY KEY,
  IDCLIENTE INT,
  TIPOFINANCIAMENTO VARCHAR (2),
  VALORTOTAL FLOAT,
  DATAVENCIMENTO DATE,
  CONSTRAINT FK_IDCLIENTE
  FOREIGN KEY (IDCLIENTE)
  REFERENCES CLIENTE (IDCLIENTE)
);


CREATE TABLE PARCELAS(
  IDPARCELA INT NOT NULL PRIMARY KEY,
  IDFINANCIAMENTO INT,
  NUMEROPARCELA INT,
  VALORPARCELA FLOAT,
  DATAVENCIMENTO DATE,
  DATAPAGAMENTO DATE,
  CONSTRAINT FK_IDFINANCIAMENTO
  FOREIGN KEY (IDFINANCIAMENTO)
  REFERENCES FINANCIAMENTO (IDFINANCIAMENTO)
);


INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(1,'LEANDRO','SP',11974329855);
INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(2,'SHIMADA','SP',11974320858);
INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(3,'JOAQUIM','AM',11912345674);
INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(4,'JOAO','RJ',11912349589);
INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(5,'FRANCISCO','SC',11912449577);
INSERT INTO CLIENTE(IDCLIENTE,NOME,UF,CELULAR) VALUES(6,'MARCELO','RJ',11979359855);

INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(1,1,'PJ',25000,'05/11/2019')
INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(2,2,'PF',10000,'04/11/2019')
INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(3,3,'CI',30000,'04/11/2019')
INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(4,4,'CC',50000,'04/11/2019')
INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(5,5,'PJ',50000,'04/11/2019')
INSERT INTO FINANCIAMENTO(IDFINANCIAMENTO,IDCLIENTE,TIPOFINANCIAMENTO,VALORTOTAL,DATAVENCIMENTO) VALUES(6,6,'CI',50000,'04/11/2019')

INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(1,2,1,10000	,'05/09/2019',NULL);
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(2,4,1,10000	,'05/09/2019',NULL);
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(3,5,1,10000	,'05/09/2019',NULL);
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(4,6,1,10000	,'05/09/2019',NULL);

INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(5,1,1,10000	,'05/09/2019','05/09/2019');
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(6,1,2,10000	,'05/10/2019','05/10/2019');
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(7,1,3,5000	,'05/10/2019','05/10/2019');

INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(8,3,1,2500	,'01/08/2019','12/08/2019');
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(9,3,2,2500	,'01/09/2019','12/09/2019');
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(10,3,3,2500	,'01/10/2019','12/10/2019');
INSERT INTO PARCELAS(IDPARCELA,IDFINANCIAMENTO,NUMEROPARCELA,VALORPARCELA,DATAVENCIMENTO,DATAPAGAMENTO) VALUES(11,3,4,2500	,'01/11/2019','01/11/2019');

-- Listar todos os clientes do estado de SP que tenham mais de 60% das parcelas pagas.

SELECT A.*
FROM   CLIENTE A 
INNER JOIN FINANCIAMENTO B ON A.IDCLIENTE = B.IDCLIENTE 
INNER JOIN PARCELAS C ON B.IDFINANCIAMENTO = C.IDFINANCIAMENTO 
WHERE A.UF = 'SP'
AND 
(
      (SELECT 
           (
             (SELECT COUNT(1)
             FROM PARCELAS P
             WHERE P.IDFINANCIAMENTO = B.IDFINANCIAMENTO
             AND P.DATAPAGAMENTO IS NOT NULL)
               * 
             100 
           ) 
             / 
           (SELECT COUNT(1)
           FROM PARCELAS P
           WHERE P.IDFINANCIAMENTO = B.IDFINANCIAMENTO  )
           
           FROM DUAL) > 60           
) 


--Listar os primeiros 4 clientes que tenham alguma parcela com mais de 05 dias atrasadas (Data Vencimento maior que data atual E data pagamento nula)

SELECT A.IDCLIENTE, 
       A.NOME 
FROM   CLIENTE A 
INNER JOIN FINANCIAMENTO B ON A.IDCLIENTE = B.IDCLIENTE 
INNER JOIN PARCELAS C ON B.IDFINANCIAMENTO = C.IDFINANCIAMENTO 
WHERE  (SELECT TO_DATE(C.DATAVENCIMENTO, 'DD/MM/YYYY') - TO_DATE(SYSDATE, 'DD/MM/YYYY') FROM DUAL) <= -5
AND DATAPAGAMENTO IS NULL
AND ROWNUM <= 4


-- Listar todos os clientes que jÃ¡ atrasaram em algum momento duas ou mais parcelas em mais de 10 dias, e que 
--o valor do financiamento seja maior que R$ 10.000,00.

SELECT 
	   CLI.NOME
FROM CLIENTE CLI
INNER JOIN FINANCIAMENTO FIN ON CLI.IDCLIENTE = FIN.IDCLIENTE
INNER JOIN PARCELAS PAR ON FIN.IDFINANCIAMENTO = PAR.IDFINANCIAMENTO
WHERE 
EXISTS 
(
  SELECT 1 
  FROM PARCELAS PARCELAS
  WHERE PARCELAS.IDFINANCIAMENTO = PAR.IDFINANCIAMENTO
  AND (SELECT TO_DATE(PARCELAS.DATAVENCIMENTO, 'DD/MM/YYYY') - TO_DATE(PARCELAS.DATAPAGAMENTO, 'DD/MM/YYYY') FROM DUAL) <= -10
)
AND FIN.VALORTOTAL > 10000
